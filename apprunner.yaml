version: 1.0
run:
  commands:
    build:
      - echo "Installing dependencies..."
      - npm ci --only=production
      - echo "Building application..."
      - npm run build
      - echo "Setting permissions..."
      - chmod +x scripts/start.sh
    start: ./scripts/start.sh
  network:
    port: 8080
    env: PORT
  env:
    - name: NODE_ENV
      value: production
    - name: DATABASE_PATH
      value: "./server/data/database.sqlite"
    - name: CLIENT_URL
      value: ${AWS_APPRUNNER_SERVICE_URL}
    - name: FRONTEND_URL
      value: ${AWS_APPRUNNER_SERVICE_URL}
    # JWT Secret from AWS Secrets Manager
    - name: JWT_SECRET
      value: "{{resolve:secretsmanager:football-pickem/jwt-secret:SecretString}}"
    - name: ADMIN_EMAIL
      value: "{{resolve:secretsmanager:football-pickem/jwt-secret:SecretString}}"
    - name: ADMIN_PASSWORD
      value: "{{resolve:secretsmanager:football-pickem/jwt-secret:SecretString}}"

    # SMTP settings (optional):
    # - SMTP_HOST
    # - SMTP_PORT
    # - SMTP_USER
    # - SMTP_PASS
    # - FROM_EMAIL
    # - SETTINGS_ENCRYPTION_KEY