version: 1.0
runtime: nodejs18  # Specify Node.js version (use nodejs16, nodejs18, etc.)

# Minimum resource configuration for AppRunner
cpu: 0.5 # 0.5 vCPU minimum for background tasks and SSR
memory: 1 # 1 GB minimum for caching, database connections, and concurrent operations

build:
  commands:
    build:
      - echo "Installing dependencies..."
      - npm ci
      - echo "Building application..."
      - npm run build
      - echo "Setting permissions..."
      - chmod +x scripts/start.sh
  env:
    # Build-time environment (no secrets here)
    - name: NODE_ENV
      value: production

run:
  runtime-version: nodejs18  # Match the runtime above
  command: ./scripts/start.sh
  network:
    port: 8080
    env: PORT
  # Health check configuration for App Runner
  health-check:
    path: "/api/health/live"
    interval: 30
    timeout: 10
    healthy-threshold: 2
    unhealthy-threshold: 5
  env:
    # Runtime Environment Configuration
    - name: NODE_ENV
      value: production
    - name: CLIENT_URL
    #  value: "${AWS_APPRUNNER_SERVICE_URL}"
    - name: FRONTEND_URL
    #  value: "${AWS_APPRUNNER_SERVICE_URL}"

    # Static Files Configuration
    - name: LOGOS_PATH
      value: "/var/app/current/public/logos"
    - name: APP_ROOT
      value: "/var/app/current"

    # Database Configuration
    - name: DATABASE_TYPE
      value: "auto"  # Uses DynamoDB in production, SQLite in development
    
    # DynamoDB Configuration
    - name: DYNAMODB_TABLE_PREFIX
      value: "football_pickem_"
    - name: AWS_REGION
      value: "us-east-1"

    # Security Configuration - Use actual secrets or ARNs
    # Replace these with actual values or AWS Secrets Manager ARNs
    - name: JWT_SECRET
      value: "your-super-secret-jwt-key-change-this-in-production"
    - name: SETTINGS_ENCRYPTION_KEY
      value: "football-pickem-default-key-32-chars!"

    # Admin Configuration
    - name: ADMIN_EMAIL
      value: "admin@nflpickem.com"
    - name: ADMIN_PASSWORD
      value: "admin123"


    # SMTP Configuration (optional - can be configured via admin panel):
    # - name: SMTP_HOST
    #   value: "{{resolve:secretsmanager:football-pickem/smtp:SecretString:smtp_host}}"
    # - name: SMTP_PORT
    #   value: "{{resolve:secretsmanager:football-pickem/smtp:SecretString:smtp_port}}"
    # - name: SMTP_USER
    #   value: "{{resolve:secretsmanager:football-pickem/smtp:SecretString:smtp_user}}"
    # - name: SMTP_PASS
    #   value: "{{resolve:secretsmanager:football-pickem/smtp:SecretString:smtp_pass}}"
    # - name: FROM_EMAIL
    #   value: "{{resolve:secretsmanager:football-pickem/smtp:SecretString:from_email}}"

    # AWS Credentials (optional - App Runner uses IAM roles by default)
    # - name: AWS_ACCESS_KEY_ID
    #   value: "{{resolve:secretsmanager:football-pickem/aws-credentials:SecretString:access_key_id}}"
    # - name: AWS_SECRET_ACCESS_KEY
    #   value: "{{resolve:secretsmanager:football-pickem/aws-credentials:SecretString:secret_access_key}}"